#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define TAMANHO_HASH 10

// Estrutura do n√≥ da √°rvore bin√°ria (sala)
typedef struct Sala {
    char nome[50];
    char *pista;  // Pista encontrada nesta sala (NULL se n√£o houver)
    char *suspeito; // Suspeito relacionado √† pista
    struct Sala *esquerda;
    struct Sala *direita;
} Sala;

// Estrutura do n√≥ da √°rvore de busca (pistas)
typedef struct NoPista {
    char pista[100];
    struct NoPista *esquerda;
    struct NoPista *direita;
} NoPista;

// Estrutura para a tabela hash (pista -> suspeito)
typedef struct NoHash {
    char pista[100];
    char suspeito[50];
    struct NoHash *proximo; // Para tratar colis√µes por encadeamento
} NoHash;

// Tabela hash global
NoHash *tabelaHash[TAMANHO_HASH];

// Fun√ß√£o hash simples (soma ASCII mod tamanho)
int funcaoHash(char *chave) {
    int soma = 0;
    for (int i = 0; chave[i] != '\0'; i++) {
        soma += chave[i];
    }
    return soma % TAMANHO_HASH;
}

// Inicializa a tabela hash
void inicializarHash() {
    for (int i = 0; i < TAMANHO_HASH; i++) {
        tabelaHash[i] = NULL;
    }
}

// Insere uma rela√ß√£o pista -> suspeito na tabela hash
void inserirNaHash(char *pista, char *suspeito) {
    int indice = funcaoHash(pista);

    // Cria novo n√≥
    NoHash *novo = (NoHash*)malloc(sizeof(NoHash));
    strcpy(novo->pista, pista);
    strcpy(novo->suspeito, suspeito);
    novo->proximo = NULL;

    // Insere no in√≠cio da lista (encadeamento)
    if (tabelaHash[indice] == NULL) {
        tabelaHash[indice] = novo;
    } else {
        novo->proximo = tabelaHash[indice];
        tabelaHash[indice] = novo;
    }
}

// Busca o suspeito relacionado a uma pista
char* buscarSuspeitoNaHash(char *pista) {
    int indice = funcaoHash(pista);
    NoHash *atual = tabelaHash[indice];

    while (atual != NULL) {
        if (strcmp(atual->pista, pista) == 0) {
            return atual->suspeito;
        }
        atual = atual->proximo;
    }

    return NULL;
}

// Conta ocorr√™ncias de cada suspeito
void contarSuspeitos(char suspeitos[][50], int contagens[], int *numSuspeitos) {
    *numSuspeitos = 0;

    for (int i = 0; i < TAMANHO_HASH; i++) {
        NoHash *atual = tabelaHash[i];
        while (atual != NULL) {
            // Verifica se o suspeito j√° est√° na lista
            int encontrado = 0;
            for (int j = 0; j < *numSuspeitos; j++) {
                if (strcmp(suspeitos[j], atual->suspeito) == 0) {
                    contagens[j]++;
                    encontrado = 1;
                    break;
                }
            }

            // Se n√£o foi encontrado, adiciona novo suspeito
            if (!encontrado) {
                strcpy(suspeitos[*numSuspeitos], atual->suspeito);
                contagens[*numSuspeitos] = 1;
                (*numSuspeitos)++;
            }

            atual = atual->proximo;
        }
    }
}

// Exibe todas as rela√ß√µes pista -> suspeito
void exibirRelacoes() {
    printf("\n--- RELA√á√ïES PISTA ‚Üí SUSPEITO ---\n");
    int encontrouAlguma = 0;

    for (int i = 0; i < TAMANHO_HASH; i++) {
        NoHash *atual = tabelaHash[i];
        while (atual != NULL) {
            printf("  ‚Ä¢ %s ‚Üí %s\n", atual->pista, atual->suspeito);
            encontrouAlguma = 1;
            atual = atual->proximo;
        }
    }

    if (!encontrouAlguma) {
        printf("  Nenhuma rela√ß√£o encontrada ainda.\n");
    }
}

// Fun√ß√µes da √Årvore Bin√°ria (Mans√£o)
Sala* criarSala(char *nome, char *pista, char *suspeito) {
    Sala *novaSala = (Sala*)malloc(sizeof(Sala));
    strcpy(novaSala->nome, nome);

    if (pista != NULL) {
        novaSala->pista = (char*)malloc(strlen(pista) + 1);
        strcpy(novaSala->pista, pista);
    } else {
        novaSala->pista = NULL;
    }

    if (suspeito != NULL) {
        novaSala->suspeito = (char*)malloc(strlen(suspeito) + 1);
        strcpy(novaSala->suspeito, suspeito);
    } else {
        novaSala->suspeito = NULL;
    }

    novaSala->esquerda = NULL;
    novaSala->direita = NULL;
    return novaSala;
}

// Fun√ß√µes da √Årvore de Busca (Pistas)
NoPista* inserirPista(NoPista *raiz, char *pista) {
    if (raiz == NULL) {
        NoPista *novo = (NoPista*)malloc(sizeof(NoPista));
        strcpy(novo->pista, pista);
        novo->esquerda = NULL;
        novo->direita = NULL;
        return novo;
    }

    if (strcmp(pista, raiz->pista) < 0) {
        raiz->esquerda = inserirPista(raiz->esquerda, pista);
    } else if (strcmp(pista, raiz->pista) > 0) {
        raiz->direita = inserirPista(raiz->direita, pista);
    }
    // Se for igual, n√£o insere (evita duplicatas)

    return raiz;
}

// Busca uma pista na BST
int buscarPista(NoPista *raiz, char *pista) {
    if (raiz == NULL) {
        return 0; // N√£o encontrada
    }

    int cmp = strcmp(pista, raiz->pista);
    if (cmp == 0) {
        return 1; // Encontrada
    } else if (cmp < 0) {
        return buscarPista(raiz->esquerda, pista);
    } else {
        return buscarPista(raiz->direita, pista);
    }
}

// Exibe todas as pistas em ordem alfab√©tica
void exibirPistasEmOrdem(NoPista *raiz) {
    if (raiz != NULL) {
        exibirPistasEmOrdem(raiz->esquerda);
        char *suspeito = buscarSuspeitoNaHash(raiz->pista);
        if (suspeito != NULL) {
            printf("  - %s [Suspeito: %s]\n", raiz->pista, suspeito);
        } else {
            printf("  - %s\n", raiz->pista);
        }
        exibirPistasEmOrdem(raiz->direita);
    }
}

// Conta o n√∫mero de pistas
int contarPistas(NoPista *raiz) {
    if (raiz == NULL) return 0;
    return 1 + contarPistas(raiz->esquerda) + contarPistas(raiz->direita);
}

// Fun√ß√£o para explorar as salas interativamente
void explorarSalas(Sala *salaAtual, NoPista **pistasEncontradas) {
    char opcao;
    int totalPistas = 0;

    while (salaAtual != NULL) {
        printf("\n================================\n");
        printf("Voc√™ est√° em: %s\n", salaAtual->nome);
        printf("================================\n");

        // Verifica se h√° pista nesta sala
        if (salaAtual->pista != NULL) {
            printf("\nüîç PISTA ENCONTRADA: %s\n", salaAtual->pista);
            if (salaAtual->suspeito != NULL) {
                printf("üïµÔ∏è  SUSPEITO RELACIONADO: %s\n", salaAtual->suspeito);
                inserirNaHash(salaAtual->pista, salaAtual->suspeito);
            }
            *pistasEncontradas = inserirPista(*pistasEncontradas, salaAtual->pista);
            totalPistas = contarPistas(*pistasEncontradas);
            printf("Total de pistas coletadas: %d\n", totalPistas);
        }

        // Verifica se √© uma folha (fim do caminho)
        if (salaAtual->esquerda == NULL && salaAtual->direita == NULL) {
            printf("\nFim do caminho! N√£o h√° mais salas para explorar.\n");
            break;
        }

        // Mostra op√ß√µes dispon√≠veis
        printf("\nOp√ß√µes:\n");
        if (salaAtual->esquerda != NULL) {
            printf("  [e] - Ir para a esquerda (%s)\n", salaAtual->esquerda->nome);
        }
        if (salaAtual->direita != NULL) {
            printf("  [d] - Ir para a direita (%s)\n", salaAtual->direita->nome);
        }
        printf("  [p] - Ver todas as pistas coletadas\n");
        printf("  [r] - Ver rela√ß√µes pista ‚Üí suspeito\n");
        printf("  [a] - Analisar suspeitos\n");
        printf("  [s] - Sair da explora√ß√£o\n");
        printf("\nEscolha uma op√ß√£o: ");
        scanf(" %c", &opcao);

        // Processa a escolha do jogador
        switch (opcao) {
            case 'e':
            case 'E':
                if (salaAtual->esquerda != NULL) {
                    salaAtual = salaAtual->esquerda;
                } else {
                    printf("N√£o h√° sala √† esquerda!\n");
                }
                break;
            case 'd':
            case 'D':
                if (salaAtual->direita != NULL) {
                    salaAtual = salaAtual->direita;
                } else {
                    printf("N√£o h√° sala √† direita!\n");
                }
                break;
            case 'p':
            case 'P':
                printf("\n--- PISTAS COLETADAS (em ordem alfab√©tica) ---\n");
                if (*pistasEncontradas == NULL) {
                    printf("  Nenhuma pista encontrada ainda.\n");
                } else {
                    exibirPistasEmOrdem(*pistasEncontradas);
                }
                printf("Total: %d pistas\n", contarPistas(*pistasEncontradas));
                break;
            case 'r':
            case 'R':
                exibirRelacoes();
                break;
            case 'a':
            case 'A':
                {
                    char suspeitos[10][50];
                    int contagens[10];
                    int numSuspeitos;

                    contarSuspeitos(suspeitos, contagens, &numSuspeitos);

                    if (numSuspeitos == 0) {
                        printf("\nNenhum suspeito identificado ainda.\n");
                    } else {
                        printf("\n--- AN√ÅLISE DE SUSPEITOS ---\n");
                        int maxContagem = 0;
                        int indiceCulpado = 0;

                        for (int i = 0; i < numSuspeitos; i++) {
                            printf("  ‚Ä¢ %s: %d pista(s)\n", suspeitos[i], contagens[i]);
                            if (contagens[i] > maxContagem) {
                                maxContagem = contagens[i];
                                indiceCulpado = i;
                            }
                        }

                        printf("\nüéØ PRINCIPAL SUSPEITO: %s (%d pistas)\n",
                               suspeitos[indiceCulpado], maxContagem);
                    }
                }
                break;
            case 's':
            case 'S':
                printf("\nSaindo da explora√ß√£o...\n");
                return;
            default:
                printf("Op√ß√£o inv√°lida! Tente novamente.\n");
        }
    }
}

// Fun√ß√£o para liberar mem√≥ria da √°rvore de salas
void liberarArvore(Sala *raiz) {
    if (raiz == NULL) return;
    liberarArvore(raiz->esquerda);
    liberarArvore(raiz->direita);
    if (raiz->pista != NULL) {
        free(raiz->pista);
    }
    if (raiz->suspeito != NULL) {
        free(raiz->suspeito);
    }
    free(raiz);
}

// Fun√ß√£o para liberar mem√≥ria da √°rvore de pistas
void liberarPistas(NoPista *raiz) {
    if (raiz == NULL) return;
    liberarPistas(raiz->esquerda);
    liberarPistas(raiz->direita);
    free(raiz);
}

// Fun√ß√£o para liberar mem√≥ria da tabela hash
void liberarHash() {
    for (int i = 0; i < TAMANHO_HASH; i++) {
        NoHash *atual = tabelaHash[i];
        while (atual != NULL) {
            NoHash *temp = atual;
            atual = atual->proximo;
            free(temp);
        }
    }
}

int main() {
    printf("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n");
    printf("‚ïë   BEM-VINDO AO DETECTIVE QUEST!       ‚ïë\n");
    printf("‚ïë          N√≠vel Mestre                 ‚ïë\n");
    printf("‚ïë   Desvende o Mist√©rio da Mans√£o       ‚ïë\n");
    printf("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n");

    // Inicializa estruturas
    inicializarHash();
    NoPista *pistasEncontradas = NULL;

    // Construindo a √°rvore da mans√£o com pistas e suspeitos
    Sala *raiz = criarSala("Hall de Entrada", NULL, NULL);

    // N√≠vel 1
    raiz->esquerda = criarSala("Biblioteca", "Livro com p√°ginas rasgadas", "Professor Archibald");
    raiz->direita = criarSala("Sala de Estar", NULL, NULL);

    // N√≠vel 2 - Esquerda (Biblioteca)
    raiz->esquerda->esquerda = criarSala("Sala de Leitura", "Marca de sangue no tapete", "Mordomo James");
    raiz->esquerda->direita = criarSala("Arquivo Secreto", "Documento confidencial", "Professor Archibald");

    // N√≠vel 2 - Direita (Sala de Estar)
    raiz->direita->esquerda = criarSala("Cozinha", "Faca desaparecida", "Chef Marie");
    raiz->direita->direita = criarSala("Sala de Jantar", "Ta√ßa com veneno", "Lady Victoria");

    // N√≠vel 3 - Cozinha
    raiz->direita->esquerda->esquerda = criarSala("Despensa", "Alimentos envenenados", "Chef Marie");
    raiz->direita->esquerda->direita = criarSala("Adega", "Garrafa de vinho vazia", "Mordomo James");

    // N√≠vel 3 - Sala de Jantar
    raiz->direita->direita->esquerda = criarSala("Sal√£o de Festas", "Bilhete an√¥nimo", "Lady Victoria");
    raiz->direita->direita->direita = criarSala("Varanda", "Pegadas suspeitas", "Jardineiro Thomas");

    // Inicia a explora√ß√£o
    explorarSalas(raiz, &pistasEncontradas);

    // Exibe relat√≥rio final
    printf("\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n");
    printf("‚ïë      RELAT√ìRIO FINAL DA INVESTIGA√á√ÉO  ‚ïë\n");
    printf("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n");

    printf("\nTotal de pistas encontradas: %d\n", contarPistas(pistasEncontradas));

    printf("\nPistas em ordem alfab√©tica:\n");
    exibirPistasEmOrdem(pistasEncontradas);

    exibirRelacoes();

    // An√°lise final
    char suspeitos[10][50];
    int contagens[10];
    int numSuspeitos;

    contarSuspeitos(suspeitos, contagens, &numSuspeitos);

    if (numSuspeitos > 0) {
        printf("\n--- AN√ÅLISE FINAL DE SUSPEITOS ---\n");
        int maxContagem = 0;
        int indiceCulpado = 0;

        for (int i = 0; i < numSuspeitos; i++) {
            printf("  ‚Ä¢ %s: %d pista(s)\n", suspeitos[i], contagens[i]);
            if (contagens[i] > maxContagem) {
                maxContagem = contagens[i];
                indiceCulpado = i;
            }
        }

        printf("\nüéØ CULPADO IDENTIFICADO: %s\n", suspeitos[indiceCulpado]);
        printf("   Evid√™ncias encontradas: %d pistas\n", maxContagem);
    }

    // Libera mem√≥ria
    liberarArvore(raiz);
    liberarPistas(pistasEncontradas);
    liberarHash();

    printf("\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n");
    printf("‚ïë    CASO RESOLVIDO! PARAB√âNS!          ‚ïë\n");
    printf("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n");
    printf("\nObrigado por jogar Detective Quest!\n");

    return 0;
}

